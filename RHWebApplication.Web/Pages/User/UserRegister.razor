@inject NavigationManager NavigationManager
@inject JobService JobService
@inject AdminService AdminService
@inject EmployeeService EmployeeService
@inject CompanyService CompanyService
@inject CustomAuthStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@page "/UserRegister"

<PageTitle> Register a User</PageTitle>
<AuthorizeView Roles="Admin, Staff">
    <Authorized Context="authContext">
        <MudContainer Class="d-flex justify-center">
            <MudCard Style="width: 50%;">
                <MudCardContent>
                    <MudForm Model="@_userRequest">
                        <MudText Class="align-center" Typo="Typo.h5">Register a User</MudText>
                        <MudTextField @bind-Value="_userRequest.Name" Label="Name" Required="true" />
                        <MudTextField @bind-Value="_userRequest.Login" Label="Login" Required="true" />
                        <MudTextField @bind-Value="_userRequest.Password" Label="Password" InputType="InputType.Password" Required="true" />
                        <MudTextField @bind-Value="_userRequest.Email" Label="Email" For="@(()=> _userRequest.Email)"  Required="true" />
                        <MudSwipeArea Class="pt-6 d-flex justify-center flex-grow-1 gap-4 align-center">
                            <MudText Align="Align.Center">Employee</MudText>
                            <MudSwitch Color="Color.Primary" @bind-Value="_IsAdmin" />
                            <MudText Align="Align.Center">Admin</MudText>
                        </MudSwipeArea>

                        <MudTextField  Disabled="@(_IsAdmin)" T="int" @bind-Value="_userRequest.Dependents" Label="Dependents" Required="@(!_IsAdmin)" />
                        <MudSelect Disabled="@(_IsAdmin)" @bind-Value="_userRequest.JobTitle" Label="Job Title" Required="@(!_IsAdmin)">
                            @{
                                foreach(var job in _jobList)
                                {
                                    if(job is not null)
                                    {
                                        <MudSelectItem Value="@job">@job</MudSelectItem>
                                    }
                                }
                            }
                        </MudSelect>
                        <MudButton Type="Submit" OnClick="SubmitUserAsync" Color="Color.Primary">Submit</MudButton>
                    </MudForm>
                    <MudText Color="Color.Error">@_errorMenssage</MudText>
                </MudCardContent>
            </MudCard>
        </MudContainer>
    </Authorized>
    <NotAuthorized>
        @{
            NavigationManager.NavigateTo("/Login");
        }
    </NotAuthorized>
</AuthorizeView>

@code {
    private EmployeeRequest _userRequest = new();
    private bool _IsAdmin = false;
    private string _errorMenssage = string.Empty;
    private List<string> _jobList = new();
    private List<string> _companyList = new();
    private string _companySelected = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        _jobList = await JobService.GetJobTitles();
        _companyList = await CompanyService.GetCompanyNames();
    }

    public async Task SubmitUserAsync()
    {
        _errorMenssage = string.Empty;
        HttpResponseMessage? response = null;
        if (_IsAdmin) //admin
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user.Identity.IsAuthenticated)
            {
                _companySelected = user.FindFirst("company").Value;
            }
            AdminRequest adminRequest = new(_userRequest.Login, _userRequest.Password, _userRequest.Name, _userRequest.Email, _companySelected);
            response = await AdminService.PostAdmin(adminRequest);
        }
        else //employee
        {
            if (_userRequest.JobTitle is not null)
            {
                response = await EmployeeService.PostEmployee(_userRequest);
            }
            else
            {
                _errorMenssage = "Necessary choice a Job Title to register a employee!";
                Snackbar.Add("Necessary choice a Job Title to register a employee!", Severity.Error);
            }
        }

        if(response is not null)
        {
            if (!response.IsSuccessStatusCode)
            {
                if (response.RequestMessage is not null)
                {
                    _errorMenssage = await response.Content.ReadAsStringAsync();
                    Snackbar.Add("User has not Registred!", Severity.Error);
                }
            }
            else
            {
                Snackbar.Add("User has been successfully Registered!", Severity.Success);
                _userRequest = new EmployeeRequest();
            }
        }

    }
}
